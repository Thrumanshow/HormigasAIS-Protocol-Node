name: ğŸœ HormigasAIS Node Health Check

on:
  push:
    branches: [ "main" ]
    tags:
      - "v*"
  pull_request:
    branches: [ "main" ]

jobs:
  health-check:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: ğŸ“¦ Install dependencies
        run: |
          # InstalaciÃ³n rÃ¡pida de dependencias crÃ­ticas
          pip install fastapi uvicorn
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: ğŸ› ï¸ Prepare Environment
        run: |
          mkdir -p logs contracts/config
          touch contracts/config/config.human # Simular contrato para el test de CI

      - name: ğŸš€ Start Node (background)
        run: |
          # Iniciamos el servidor en segundo plano
          python3 -m uvicorn api.main:app --host 127.0.0.1 --port 8000 &
          sleep 5

      - name: ğŸ©º Health Check (/v1/health)
        run: |
          # La prueba de fuego: si el JSON no es correcto, el CI falla
          curl --fail http://127.0.0.1:8000/v1/health | tee health.json
          grep '"status":"OPERATIONAL"' health.json
          grep '"sovereignty":"ENFORCED"' health.json

      - name: ğŸ§¾ Seal Audit Log
        run: |
          echo "LBH CI CHECK PASSED - $(date)"
